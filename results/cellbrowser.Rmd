---
title: "Format UCSC cellbrowser"
author: "Kent Riemondy RBI"
date: "`R Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Cellbrowser

Format seurat object into a cellbrowser directory suitable for html browser. 

```{r}
library(scbp)
library(tidyverse)
```

```{R}
cb_outdir <- "cellbrowser_v2"

def_embeddings <- function(so) {
  # keep everything except PCA
  reductions <- names(so@reductions)
  reductions[!str_detect(reductions, "pca")]}
```

# All cells


```{r}
so <- readRDS(file.path("objects", "sobj.rds"))

cols_to_keep <- c(
  `genes per cell` = "nFeature_RNA",
  `UMIs per cell` = "nCount_RNA",
  `percent of UMIs as mitochondria` = "percent.mt",
  `clusters` = "clusters",
  `sample` = "orig.ident",
  `cell cycle phase` = "Phase",
  `Tabula Muris cell type` = "tabula_muris_cell_type"
)

make_cellbrowser(so, 
                 column_list = cols_to_keep,
                 # secondary_cols = c(
                 #    "subgroup",
                 #    "cell_type"), 
                 project = "ameloblasts",
                 outdir = cb_outdir,
                 marker_file = "markers/per_cluster_markers.tsv",
                 ident = "clusters",
                 embeddings = def_embeddings(so),
                 skip_expr_matrix = TRUE,
                 description = list(title = "Amelogenesis",
                                    description = "Developing mouse incisor lineages")
                 )
```

## Just ameloblasts


```{r}
so <- readRDS(file.path("objects", "ablast_sobj.rds"))

cols_to_keep <- c(
  `genes per cell` = "nFeature_RNA",
  `UMIs per cell` = "nCount_RNA",
  `percent of UMIs as mitochondria` = "percent.mt",
  `clusters` = "clusters",
  `sample` = "orig.ident",
  `cell cycle phase` = "Phase",
  `Tabula Muris cell type` = "tabula_muris_cell_type",
  `Preliminary cell type` = "cell_type",
  CytoTRACE = "CytoTRACE",
  Pseudotime_early_diff = "dpt_pseudotime_early_diff",
  Pseudotime_late_diff = "dpt_pseudotime_late_diff"
)

ncb_modules <- str_subset(colnames(so@meta.data), "Sharir_et_al")
names(ncb_modules) <- ncb_modules


cols_to_keep <- c(cols_to_keep, ncb_modules)

make_cellbrowser(so, 
                 column_list = cols_to_keep,
                 project = "ameloblasts_subset",
                 outdir = cb_outdir,
                 marker_file = "markers/ablast_subset_cell_type_markers.tsv",
                 ident = "Preliminary cell type",
                 embeddings = c("umap", "paga_umap", "paga_fdg"),
                 skip_expr_matrix = TRUE,
                 description = list(title = "Ameloblast lineage",
                                    description = "Subset of cells involved in ameloblast differentiation"),
                 config = list(priority = 1)
                 )
```


## Just ameloblasts early


```{r}
so <- qs::qread(file.path("objects", "ameloblast_early_diff.rds"))

cols_to_keep <- c(
  `genes per cell` = "nFeature_RNA",
  `UMIs per cell` = "nCount_RNA",
  `percent of UMIs as mitochondria` = "percent.mt",
  `clusters` = "refined_ameloblast_early_clusters",
  `sample` = "orig.ident",
  `cell cycle phase` = "Phase",
  `Tabula Muris cell type` = "tabula_muris_cell_type",
  `Preliminary cell type` = "cell_type",
  CytoTRACE = "CytoTRACE",
  Pseudotime_early_diff = "dpt_pseudotime_early_diff",
  Pseudotime_late_diff = "dpt_pseudotime_late_diff"
)

ncb_modules <- str_subset(colnames(so@meta.data), "Sharir_et_al")
names(ncb_modules) <- ncb_modules

cols_to_keep <- c(cols_to_keep, ncb_modules)

make_cellbrowser(so, 
                 column_list = cols_to_keep,
                 project = "ameloblasts_subset_early",
                 outdir = cb_outdir,
                 marker_file = "markers/ameloblast_early_diff_only/refined_ameloblast_early_clusters.tsv",
                 ident = "clusters",
                 embeddings = c("harmony_umap"),
                 skip_expr_matrix = FALSE,
                 description = list(title = "Ameloblast lineage",
                                    description = "Subset of cells involved in ameloblast differentiation"),
                 config = list(priority = 3)
                 )
```


## Just ameloblasts late


```{r}
so <- qread(file.path("objects", "ameloblast_late_diff.rds"))

cols_to_keep <- c(
  `genes per cell` = "nFeature_RNA",
  `UMIs per cell` = "nCount_RNA",
  `percent of UMIs as mitochondria` = "percent.mt",
  `clusters` = "refined_ameloblast_clusters",
  `sample` = "orig.ident",
  `cell cycle phase` = "Phase",
  `Tabula Muris cell type` = "tabula_muris_cell_type",
  `Preliminary cell type` = "cell_type",
  CytoTRACE = "CytoTRACE",
  Pseudotime_early_diff = "dpt_pseudotime_early_diff",
  Pseudotime_late_diff = "dpt_pseudotime_late_diff"
)

ncb_modules <- str_subset(colnames(so@meta.data), "Sharir_et_al")
names(ncb_modules) <- ncb_modules


cols_to_keep <- c(cols_to_keep, ncb_modules)

make_cellbrowser(so, 
                 column_list = cols_to_keep,
                 project = "ameloblasts_subset_late",
                 outdir = cb_outdir,
                 marker_file = "markers/ameloblast_late_diff_only/refined_ameloblast_clusters.tsv",
                 ident = "clusters",
                 embeddings = c("harmony_umap"),
                 skip_expr_matrix = FALSE,
                 description = list(title = "Ameloblast lineage",
                                    description = "Subset of cells involved in late ameloblast differentiation"),
                 config = list(priority = 4)
                 )
```


## Build all

```{r}
cb_dirs <- c(
  "ameloblasts_subset",
  "ameloblasts",
  "ameloblasts_subset_early",
  "ameloblasts_subset_late"
)
cb_dirs <- file.path(cb_outdir, 
                     cb_dirs,
                     "cellbrowser.conf")

build_cellbrowser(cb_dirs, 
                  file.path(cb_outdir, "ablast"))
  
```
